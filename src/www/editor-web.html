<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel=stylesheet href="../doc/docs.css">
    <link rel="stylesheet" href="../lib/codemirror.css">
    <link rel="stylesheet" href="../theme/tomorrow-night-bright.css">
    <link rel="stylesheet" href="../addon/hint/show-hint.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="../lib/codemirror.js"></script>
    <script src="../addon/edit/closetag.js"></script>
    <script src="../addon/edit/closebrackets.js"></script>
    <script src="../addon/fold/xml-fold.js"></script>
    <script src="../mode/xml/xml.js"></script>
    <script src="../mode/javascript/javascript.js"></script>
    <script src="../mode/css/css.js"></script>
    <script src="../mode/htmlmixed/htmlmixed.js"></script>
    <script src="../mode/markdown/markdown.js"></script>
    <script src="../addon/hint/show-hint.js"></script>
    <script src="../addon/hint/javascript-hint.js"></script>
    <!-- Outros -->
    <script src="../js/auto-complete.js"></script>
    <script src="../js/script.js"></script>
    <link rel="stylesheet" href="../css/editor.css" />
  </head>
  <body>
    <!-- Barra de navegação -->
    <header id="header" class="header">
      <a href="/Icones/icon.png">Icon</a>
  </header>
<nav class="dp-menu">
    <ul>
        <li><a href="#">Projeto</a>
            <ul>
                <li><input type="button" value="Página Inicial" onclick="window.location.replace('../../index.html')"></li>
                <li><input type="button" value="Novo Projeto" onclick="openNewProject()"></li>
                <li><input type="button" value="Abrir Arquivo" onclick="openArq()"></li>
                <li><input type="button" value="Salvar" onclick="salvar()"></li>
                <li><input type="button" value="Salvar Arquivo" onclick="salvarArq()"></li>
                <li><input type="button" value="Exportar em .zip" onclick="gerarZip()"></li>
            </ul>
        </li>
        <li><a href="#">Editar</a>
            <ul>
                <li><input type="button" value="Copiar Tudo" onclick="copiarTudo()"></li>
                <li><input type="button" value="Colar" onclick="colar()"></li>
                <li><input type="button" value="Apagar Tudo" onclick="apagarTudo()"></li>
            </ul>
        </li>
        <li><a href="#">Ferramentas</a>
          <ul>
              <li>teste</li>
          </ul>
      </li>
        <li><a href="#">Vizualisar</a>
            <ul>
                <li><input type="button" value="Visualização Web" onclick="previewWindow()"></li>
                <li><input type="button" value="Visualização Mobile" onclick="previewIframe()"></li>
                <li><input type="button" value="Atualizar" onclick="previewIframe()"></li>
            </ul>
        </li>
        <li><a href="#">Preferencias</a>
            <ul>
                <li><input type="button" value="Tela Cheia" onclick="fullscreen(), systemMgs('erro', 'arquivo não salvo')"></li>
                <li><input type="button" value="Temas" onclick="fullscreen()"></li>
            </ul>
        </li>
        <li><a href="#">Sobre</a>
            <ul>
                <li><a href="#">Versão</a></li>
                <li><a href="#">Documentação</a></li>
                <li><a href="#">Criadores</a></li>
                <li><a href="#">Github</a></li>
            </ul>
        </li>
    </ul>
</nav>
    <!-- Campo do editor de código-->
    <div class="conteiner-editor">
      <textarea  id="editor"></textarea>
      <!-- Campo para visualização da pagina html-->
      <iframe id="iframe-prev"></iframe>
    </div>
    
    <!-- input file onde o usuario ira escolher so seu sistema um arquivo nos formatos definidos -->
    <input style="display: none;" type="file" id="inputFile" accept=".js, .json, .html, .css">
    
    <script>
      //carregar o conteúdo de código salvo no localstorage
      window.onload = function() {
        editor.setValue(localStorage.getItem('CCE-arquivo-conteudo'))
      }

      let myWords = html5Syntax();

      // Seta as configurações do edditor
      const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: "htmlmixed", //htmlmixed  modo composto que inclui o html, javascript e css.
        theme: "tomorrow-night-bright",
        extraKeys: { "Ctrl-Space": "autocomplete" },
        lineNumbers: true,
        autoCloseTags: true,
        autoCloseBrackets: true,
        hintOptions: {
           completeSingle: false,
           hint: myHintFunction}
      });

      // Função para sujestões de código
      function myHintFunction(editor) {
        const cursor = editor.getCursor();
        const token = editor.getTokenAt(cursor);
        const start = token.start;
        const end = cursor.ch;
        const line = cursor.line;
        const currentWord = token.string;
        const wordList = myWords.filter(function (word) {
          return word.startsWith(currentWord);
          });
            if (wordList.length > 0) {
            return {
            list: wordList,
            from: CodeMirror.Pos(line, start),
            to: CodeMirror.Pos(line, end)
          };
        }
      }

      // carregando um arquivo
      const inputFile = document.getElementById("inputFile");
      inputFile.addEventListener("change", () => {
        const file = inputFile.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          const content = event.target.result;
          editor.setValue(content);
      };
      reader.readAsText(file);
      });

      //preview em nova janela
      function previewWindow() {
        const code = editor.getValue();
        const previewWindow = window.open("", "preview", "width=800,height=600");
        previewWindow.document.open();
        previewWindow.document.write('');
        previewWindow.document.write(code);
        previewWindow.onbeforeunload = function() {
        previewWindow.close();
       };
      }

      // Atualizar o conteúdo do iframe
      function previewIframe() {
        const code = editor.getValue();
        const iframe = document.getElementById("iframe-prev");
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(code);
        iframeDoc.close();
      }

      // gerar o arquivo ZIP e baixá-lo no navegador
      function gerarZip() {
        const zip = new JSZip();
        const namefile = localStorage.getItem("CCE-arquivo-nome");
        const code = editor.getValue();
        zip.file(namefile, code);
        zip.generateAsync({ type: "blob" }).then(function(blob) {
        saveAs(blob, "meu-projeto.zip");
        });
        
      }

      // salvar arquivo no computador
      function salvarArq() {
        const code = editor.getValue();
        const namefile = localStorage.getItem("CCE-arquivo-nome");
        const blob = new Blob([code], {type: "text/plain;charset=utf-8"});
        saveAs(blob, namefile);
      }

      // salva o código editado apenas no locastorage
      function salvar() {
        const code = editor.getValue();
        localStorage.setItem('CCE-arquivo-conteudo', code)
        window.location.reload();
      }

      // copia o texto do clipboard e cola no editor
      async function colar() {
        try {
          if (navigator.clipboard) {
          const text = await navigator.clipboard.readText();
          editor.setValue(text)
          }
        }catch (error){
          console.log("erro ao acessar o navigator.clipboard\n " + error)
        }
      }

      // copiar todo o texto do editor para o clipboard
      async function copiarTudo() {
        const text = editor.getValue();
        try {
          if(navigator.clipboard){
            await navigator.clipboard.writeText(text)
          }
        } catch (error) {
          console.log("erro ao acessar o navigator.clipboard\n" + error)
        }

      }

      //apagar todo o código do editor
      function apagarTudo() {
        editor.setValue("");

      }  
    </script>

    <!-- Toast de menssagens do sistema-->
    <div class="toast">
      <div class="toast-content">
          <i class="fas fa-solid fa-exclamation"></i>
          <div class="message">
              <span class="text text-1">Erro</span>
              <span class="text text-2">erro de sintaxe</span>
          </div>
      </div>
      <i class="fa-solid fa-xmark close"></i>
      <div class="progress"></div>
   </div> 

  </body>
</html>
